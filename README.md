# Белый список

Telegram-бот для проверки исполнителей компаниями. Сервис помогает компаниям безопасно нанимать сотрудников и защищаться от мошенников.

## Описание

"Белый список" — это система репутации для исполнителей, которая позволяет:

- **Исполнителям** регистрироваться, получать уникальный ID и формировать репутацию через отзывы компаний
- **Компаниям** проверять исполнителей перед наймом, оставлять отзывы и управлять сотрудниками
- **Клиентам** проверять исполнителей по ID перед заказом услуг

## Основные возможности

### Для исполнителей
- Регистрация с указанием паспортных данных (шифруются)
- Получение уникального публичного ID (формат: M-123456)
- Прикрепление к компаниям с подтверждением паспорта
- Просмотр отзывов и подача жалоб на несправедливые отзывы
- Запрос на увольнение

### Для компаний
- Регистрация компании с получением публичного ID (формат: C-123456)
- Принятие/отклонение запросов от исполнителей
- Подтверждение паспортных данных исполнителей
- Оставление отзывов по завершении сотрудничества
- Проверка исполнителей по ID перед наймом
- Подписка для доступа к функциям (1, 3, 6, 12 месяцев со скидками)

### Для обычных пользователей
- Проверка исполнителей по публичному ID
- Просмотр истории сотрудничества и отзывов

### Административные функции
- Управление компаниями и исполнителями
- Рассмотрение жалоб на отзывы
- Выдача подписок
- Блокировка/разблокировка пользователей

## Админ-панель (Web)

Для веб-доступа добавлена административная панель с RBAC и журналом действий (audit log).

**Запуск:**
```bash
python admin_web.py
```

**Создание администратора:**
```bash
python admin_web.py create-admin --username admin --password strong_pass --role SuperAdmin
```

**Переменные окружения:**
- `ADMIN_WEB_SECRET` — секрет для сессий (если не указан, используется `BOT_TOKEN`)
- `ADMIN_WEB_PORT` — порт веб-панели (по умолчанию 8080)

**Роли по умолчанию:**
- SuperAdmin — полный доступ
- Compliance — доступы, блокировки, экспорт
- DisputeModerator — споры/апелляции
- KYCOperator — верификация
- Finance — подписки
- Support — ручные правки
- Analyst — только чтение аналитики

## Установка

### Требования
- Python 3.8+
- Telegram Bot Token

### Шаги установки

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=your_telegram_bot_token
ADMINS=123456789,987654321
PAYMENT_CARD=0000 0000 0000 0000
DB_PATH=bot.db
LOG_LEVEL=INFO
PASSPORT_SECRET=your_secret_key_for_encryption
```

**Параметры:**
- `BOT_TOKEN` — токен бота от @BotFather (обязательно)
- `ADMINS` — ID администраторов через запятую (обязательно)
- `PAYMENT_CARD` — номер карты для оплаты подписок
- `DB_PATH` — путь к файлу базы данных (по умолчанию: bot.db)
- `LOG_LEVEL` — уровень логирования (DEBUG, INFO, WARNING, ERROR)
- `PASSPORT_SECRET` — секретный ключ для шифрования паспортных данных (если не указан, используется BOT_TOKEN)

4. Запустите бота:
```bash
python bot.py
```

Или используйте `start_bot.bat` на Windows.

**Важно:** Если бот не запускается, проверьте:
- Файл `.env` создан и содержит `BOT_TOKEN`
- Все зависимости установлены: `pip install -r requirements.txt`
- Python версии 3.8 или выше

Для диагностики проблем запустите:
```bash
python test_imports.py
```

## Структура проекта

```
.
├── bot.py              # Основной файл бота
├── config.py           # Конфигурация
├── db.py               # Работа с базой данных
├── keyboards.py        # Клавиатуры для интерфейса
├── security.py         # Шифрование паспортных данных
├── requirements.txt    # Зависимости
├── start_bot.bat      # Скрипт запуска для Windows
├── states/            # Управление состояниями пользователей
│   ├── __init__.py
│   └── state_manager.py
└── utils/             # Утилиты
    ├── __init__.py
    ├── formatters.py   # Форматирование текста
    └── validators.py   # Валидация входных данных
```

## База данных

Бот использует SQLite для хранения данных. База данных создаётся автоматически при первом запуске.

**Таблицы:**
- `users` — пользователи Telegram
- `masters` — исполнители
- `companies` — компании
- `employments` — сотрудничество между исполнителями и компаниями
- `reviews` — отзывы компаний об исполнителях
- `review_appeals` — жалобы на отзывы
- `user_states` — состояния пользователей (state machine)

## Безопасность

- Паспортные данные шифруются с использованием Fernet (cryptography)
- Ключ шифрования генерируется из `PASSPORT_SECRET` или `BOT_TOKEN`
- Паспортные данные не отображаются полностью (показываются только последние 4 цифры)

## Подписки

Компании могут оформить подписку для доступа к функциям:
- 1 месяц — 790 ₽
- 3 месяца — 750 ₽ (скидка 5%)
- 6 месяцев — 711 ₽ (скидка 10%)
- 12 месяцев — 672 ₽ (скидка 15%)

Оплата осуществляется переводом на карту. После отправки чека администратор проверяет и выдаёт подписку.

## Жалобы на отзывы

Исполнители могут подать жалобу на отзыв в течение 14 дней после его создания (максимум 3 попытки).

Процесс:
1. Исполнитель подаёт жалобу с обоснованием
2. Компания получает уведомление и может предоставить ответ с доказательствами
3. Если компания не ответит в течение 5 дней, отзыв автоматически удаляется
4. Администратор рассматривает жалобу и принимает решение

## Автоматические задачи

Бот выполняет фоновые задачи каждый час:
- Автоматическое завершение сотрудничества при запросе на увольнение (через 2 дня)
- Напоминание компаниям о жалобах (через 3 дня)
- Автоматическое удаление отзывов при отсутствии ответа компании (через 5 дней)
- Очистка устаревших состояний пользователей (старше 24 часов)

## Разработка

### Добавление новых функций

1. Обработчики команд и callback'ов добавляются в `bot.py`
2. Клавиатуры создаются в `keyboards.py`
3. Функции работы с БД — в `db.py`
4. Валидация — в `utils/validators.py`
5. Форматирование — в `utils/formatters.py`

### Логирование

Используется стандартный модуль `logging` Python. Уровень логирования настраивается через переменную окружения `LOG_LEVEL`.

## Лицензия

Проект создан для внутреннего использования.

## Поддержка

При возникновении проблем проверьте:
1. Правильность токена бота в `.env`
2. Наличие всех зависимостей (`pip install -r requirements.txt`)
3. Логи бота на наличие ошибок
